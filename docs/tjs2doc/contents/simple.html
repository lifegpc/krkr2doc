<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh">
<!-- generated by to_html.pl from simple.xml -->
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>基本用法</title>
	<meta name="author" content="W.Dee" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta http-equiv="Content-Script-Type" content="text/javascript" />
	<link href="browser.css" type="text/css" rel="stylesheet" title="吉里吉里相关参考标准样式" />
	<link href="mailto:dee@kikyou.info" rev="Made" />
	<link href="index.html" target="_top" rel="Start" title="首页" />
</head>
<body>
<h1><a id="id318" name="id318">编译</a>
</h1><div class="para"><div>
　可以使用Borland C++ 5.5以上版本（C++ Builder 5以上版本）进行编译。<br />
<br />
　编译需要boost.org的regex++。<br />
<br />
　安装regex++后，请编译各个cpp文件。<br />
<br />
　对于C++ Builder，只需将tjs2的各个cpp文件全部添加到项目中即可。<br />
<br />
　也可以使用gcc 3以上版本编译（2.95版本也可以编译，但需要对wstring相关内容进行修改）。<br />
</div></div>
<h1><a id="id319" name="id319">简单示例</a>
</h1><div class="para"><div>
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>#include&nbsp;&lt;stdio.h&gt;<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>#include&nbsp;&quot;tjs.h&quot;<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>#include&nbsp;&quot;tjsError.h&quot;<br />
<span class="linenumber">&nbsp;&nbsp;4|</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>int&nbsp;main(int&nbsp;argc,&nbsp;char*&nbsp;argv[])<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;setlocale(LC_ALL,&nbsp;&quot;&quot;);&nbsp;<span class="comment">//&nbsp;设置区域设置</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;tTJS&nbsp;*tjsengine&nbsp;=&nbsp;new&nbsp;tTJS();&nbsp;<span class="comment">//&nbsp;创建TJS2脚本引擎</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;try<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;用于接收结果的变量</span><br />
<span class="linenumber">&nbsp;14|</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(<br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;function&nbsp;test(x,&nbsp;y)&nbsp;{&nbsp;return&nbsp;x*y;&nbsp;}&nbsp;\n&quot;<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;return&nbsp;test(4,&nbsp;5);\n&quot;),<br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;result,&nbsp;NULL,<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(&quot;test&nbsp;code&quot;));&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;执行测试脚本</span><br />
<span class="linenumber">&nbsp;21|</span><br />
<span class="linenumber">&nbsp;22|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;结果&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;显示结果</span><br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;24|</span>&nbsp;&nbsp;&nbsp;&nbsp;catch(eTJSError&nbsp;&amp;e)<br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;26|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;发生错误&nbsp;:&nbsp;%ls\n&quot;,&nbsp;e.GetMessage().c_str());<br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;28|</span>&nbsp;&nbsp;&nbsp;&nbsp;catch(...)<br />
<span class="linenumber">&nbsp;29|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;发生错误\n&quot;);<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;32|</span><br />
<span class="linenumber">&nbsp;33|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;Shutdown();&nbsp;<span class="comment">//&nbsp;关闭TJS2脚本引擎</span><br />
<span class="linenumber">&nbsp;34|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;Release();&nbsp;<span class="comment">//&nbsp;释放TJS2脚本引擎</span><br />
<span class="linenumber">&nbsp;35|</span><br />
<span class="linenumber">&nbsp;36|</span>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br />
<span class="linenumber">&nbsp;37|</span>}<br />
</code>
<br />

<br />
<dl>
<dt>2～3行目</dt>
<dd>引入使用TJS2所需的头文件。tjsError.h包含TJS的C++异常声明。</dd>


<dt>7行目</dt>
<dd>使用setlocale指定区域设置。如果不指定区域设置，将使用"C"区域设置，这会导致日文字符的窄字符和宽字符之间的转换不正确。</dd>


<dt>9行目</dt>
<dd>使用new运算符创建TJS2脚本引擎。</dd>


<dt>11行目</dt>
<dd>进入try块。由于TJS2的错误通过异常通知，因此需要谨慎处理异常。</dd>


<dt>13行目</dt>
<dd>　声明tTJSVariant类型的变量用于接收脚本执行结果。</dd>


<dt>15～20行目</dt>
<dd>　使用tTJS::ExecScript执行脚本。<br />
　第1个参数指定要执行的脚本。为了以tjs_char *类型传递，使用TJS_W宏将字符串字面量转换为宽字符串。该脚本定义了函数test，并返回调用该函数的结果。<br />
　在此例中，通过return语句返回执行结果，并在result变量中接收，但如果不需要接收结果，则不需要return语句和tTJS::ExecScript的第2个参数（此时将第2个参数指定为NULL）。<br />
　tTJS::ExecScript的第3个参数是执行上下文，此处指定为NULL。指定NULL时，脚本将在global上下文中执行。<br />
　tTJS::ExecScript的第4个参数指定该脚本的名称。如果为NULL，则被视为匿名。需要是人类可读的名称。</dd>


<dt>22行目</dt>
<dd>　显示结果。这里将tTJSVariant类型转换为int类型。</dd>


<dt>24行目</dt>
<dd>　捕获eTJSError类型的异常。</dd>


<dt>26行目</dt>
<dd>　使用eTJSError::GetMessage显示异常原因。使用tTJSString::c_str将消息转换为const tjs_char *。由于tjs_char是宽字符，因此printf的转换说明符使用%ls。</dd>


<dt>28行目</dt>
<dd>　捕获其他异常。</dd>


<dt>33～34行目</dt>
<dd>　释放TJS2脚本引擎。在释放之前，使用tTJS::Shutdown关闭TJS2脚本引擎。</dd></dl></div></div>

<h1><a id="id320" name="id320">调用TJS2端的函数</a>
</h1><div class="para"><div>
　从C++调用TJS2端声明的函数的方法。<br />
　将上述try块中的内容改写如下：<br />
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;用于接收结果的变量</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(&quot;function&nbsp;test(x,&nbsp;y)&nbsp;{&nbsp;return&nbsp;x*y;&nbsp;}&quot;),&nbsp;NULL,&nbsp;NULL,&nbsp;TJS_W(&quot;test&quot;));<br />
<span class="linenumber">&nbsp;&nbsp;5|</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;EvalExpression(TJS_W(&quot;test(4,&nbsp;5)&quot;),&nbsp;&amp;result,&nbsp;NULL,&nbsp;NULL);<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;使用tTJS::EvalExpression执行表达式</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;结果&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;显示结果</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;获取全局对象</span><br />
<span class="linenumber">&nbsp;13|</span><br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;param[]&nbsp;=&nbsp;{&nbsp;4,&nbsp;5&nbsp;};&nbsp;<span class="comment">//&nbsp;作为参数传递的变量</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;*p_param[]&nbsp;=&nbsp;{&nbsp;param&nbsp;+&nbsp;0,&nbsp;param&nbsp;+&nbsp;1&nbsp;};&nbsp;<span class="comment">//&nbsp;变量指针的数组</span><br />
<span class="linenumber">&nbsp;16|</span><br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(global-&gt;FuncCall(0,&nbsp;TJS_W(&quot;test&quot;),&nbsp;NULL,&nbsp;&amp;result,&nbsp;2,&nbsp;p_param,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;将test作为函数调用</span><br />
<span class="linenumber">&nbsp;19|</span><br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;结果&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;显示结果</span><br />
</code>
<br />

<br />
<dl>
<dt>3～4行目</dt>
<dd>　声明函数test。test将被注册到global中。</dd>


<dt>6行目</dt>
<dd>　使用tTJS::EvalExpression执行表达式。如果对速度要求不是很严格，这样以字符串形式传递表达式并接收其结果会比较方便。<br />
　顺便说一下，对于简单的表达式（不包含其他执行单位，如函数声明等），编译结果会被缓存，这样第二次以后的表达式求值可以更快地进行。</dd>


<dt>11行目</dt>
<dd>　获取全局对象。tTJS::GetGlobal和tTJS::GetGlobalNoAddRef的区别在于，前者会增加global对象的引用计数，而后者不会。<br />
　增加引用计数，使用完后再减少引用计数，意味着在此期间对该对象施加锁定，防止它被销毁。在这个例子中，不用担心global对象被销毁，所以可以使用tTJS::GetGlobalNoAddRef，不需要操作引用计数。同样，在这种情况下，使用完后不需要调用Release。</dd>


<dt>14～15行目</dt>
<dd>　准备传递给函数的参数。由于iTJSDispatch::FuncCall需要tTJSVariant类型指针的数组作为传递给函数的参数，所以需要这样准备。</dd>


<dt>17行目</dt>
<dd>　使用iTJSDispatch2::FuncCall调用函数"test"。<br />
　FuncCall的最后一个参数是传递给函数test的this（执行上下文），但在这个例子中声明的test内部没有使用this，所以可以指定为NULL。如果有需要执行的上下文，则需要指定该对象。<br />
　TJS_THROW_IF_ERROR是一个宏，当tjs_error类型的结果为错误时，会抛出带有相应错误消息的异常。</dd></dl></div></div>

<h1><a id="id321" name="id321">原生函数</a>
</h1><div class="para"><div>
　可以创建原生实现（用C++等语言实现的函数），并从TJS2端访问它们。<br />
　即使不是C++，只要能实现iTJSDispatch2接口的语言，都可以调用用任何语言编写的函数，但C++是最方便的。<br />
<br />
　用C++编写函数时，从tTJSNativeFunction（在tjsNative.h中定义）派生类是最方便的（但是，只要实现iTJSDispatch2的FuncCall也可以作为函数使用）。<br />
<br />
　下面实现一个简单的函数，将给定的两个参数相乘并返回结果。<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;TestFunc&nbsp;:&nbsp;public&nbsp;tTJSNativeFunction<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_error&nbsp;Process(tTJSVariant&nbsp;*result,&nbsp;tjs_int&nbsp;numparams,<br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;**param,&nbsp;iTJSDispatch2&nbsp;*objthis)<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&lt;&nbsp;2)&nbsp;return&nbsp;TJS_E_BADPARAMCOUNT;&nbsp;<span class="comment">//&nbsp;参数不足</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!result)&nbsp;return&nbsp;TJS_S_OK;&nbsp;<span class="comment">//&nbsp;如果不需要存储结果，直接返回</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;*param[0]&nbsp;*&nbsp;*param[1];&nbsp;<span class="comment">//&nbsp;计算</span><br />
<span class="linenumber">&nbsp;12|</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;&nbsp;<span class="comment">//&nbsp;返回TJS_S_OK表示正常结束</span><br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;15|</span>};<br />
</code>
<br />

<br />
　继承tTJSNativeFunction的类需要实现的只有上述的Process方法。<br />
　Process方法的参数如下：<br />
<br />
<dl>
<dt>tTJSVariant *result</dt>
<dd>　传递一个指向tTJSVariant类型变量的指针，用于存储函数的结果。<em>如果调用方不需要结果，将传递NULL</em>，请注意这一点。</dd>


<dt>tjs_int numparams</dt>
<dd>　传递给函数的参数数量。</dd>


<dt>tTJSVariant **param</dt>
<dd>　存储传递给函数的参数的tTJSVariant类型变量指针数组。</dd>


<dt>iTJSDispatch2 *objthis</dt>
<dd>　函数应该执行的上下文。如果实现与上下文无关，可以忽略。</dd></dl><br />
<br />
<br />
　原生函数需要注册到TJS2内部可访问的对象中，以便从TJS2访问。以下示例将其以"test"的名称注册到global中，并实际调用该函数。<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;获取全局对象</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span><br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*func&nbsp;=&nbsp;new&nbsp;TestFunc();&nbsp;<span class="comment">//&nbsp;创建TestFunc对象</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;func_var(func);&nbsp;<span class="comment">//&nbsp;将对象设置到tTJSVariant类型的func_var中</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func-&gt;Release();&nbsp;<span class="comment">//&nbsp;释放func</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global-&gt;PropSet(TJS_MEMBERENSURE,&nbsp;TJS_W(&quot;test&quot;),&nbsp;NULL,&nbsp;&amp;func_var,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;注册</span><br />
<span class="linenumber">&nbsp;11|</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;用于接收结果的变量</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;EvalExpression(TJS_W(&quot;test(4,&nbsp;5)&quot;),&nbsp;&amp;result,&nbsp;NULL,&nbsp;NULL);<br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;使用tTJS::EvalExpression执行表达式</span><br />
<span class="linenumber">&nbsp;15|</span><br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;结果&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;显示结果</span><br />
</code>
<br />

<br />
<dl>
<dt>4～6行目</dt>
<dd>　创建实现原生函数的TestFunc类的对象，并将其转换为tTJSVariant类型。<br />
　在第5行转换为tTJSVariant类型时，tTJSVariant类型会自动管理函数对象的引用计数，因此在第6行释放了函数对象。</dd>


<dt>8～9行目</dt>
<dd>　将函数以"test"的名称注册到global对象。调用global对象的iTJSDispatch2::PropSet，并使用TJS_MEMBERENSURE标志来创建新成员。</dd>


<dt>12～16行目</dt>
<dd>　实际调用函数并显示结果。</dd></dl></div></div>
<h1><a id="id322" name="id322">原生类</a>
</h1><div class="para"><div>
　TJS2具有处理用C++等语言编写的原生类的机制。<br />
　每个对象（iTJSDispatch2接口）都可以注册一个称为原生实例的iTJSNativeInstance类型对象，并可以从对象中取出这个原生实例。<br />
　原生实例通过唯一的类ID标识，创建原生类时需要获取类ID。<br />
<br />
　但是，tjsNative.h中定义了用于执行这些操作的宏组，使用这些宏会比较方便。<br />
　以下示例使用这些宏实现一个简单的类。<br />
<br />
　首先是原生实例的实现。要实现原生实例，需要从tTJSNativeInstance派生类。tTJSNativeInstance是在tjsNative.cpp/tjsNative.h中实现的类，它实现了iTJSNativeInstance的基本操作。<br />
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;NI_Test&nbsp;:&nbsp;public&nbsp;tTJSNativeInstance&nbsp;<span class="comment">//&nbsp;原生实例</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;NI_Test()<br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;构造函数</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;0;<br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;&nbsp;9|</span><br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_error&nbsp;TJS_INTF_METHOD<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Construct(tjs_int&nbsp;numparams,&nbsp;tTJSVariant&nbsp;**param,&nbsp;iTJSDispatch2&nbsp;*tjs_obj)<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;当创建TJS2对象时被调用</span><br />
<span class="linenumber">&nbsp;14|</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;如果有参数，将其作为Value的初始值</span><br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&gt;=&nbsp;1&nbsp;&amp;&amp;&nbsp;param[0]-&gt;Type()&nbsp;!=&nbsp;tvtVoid)<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;(tjs_int)*param[0];<br />
<span class="linenumber">&nbsp;18|</span><br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;S_OK;<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;21|</span><br />
<span class="linenumber">&nbsp;22|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;TJS_INTF_METHOD&nbsp;Invalidate()<br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;24|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;当对象被无效化时调用</span><br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;26|</span><br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;SetValue(tjs_int&nbsp;n)&nbsp;{&nbsp;Value&nbsp;=&nbsp;n;&nbsp;}<br />
<span class="linenumber">&nbsp;28|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;GetValue()&nbsp;const&nbsp;{&nbsp;return&nbsp;Value;&nbsp;}<br />
<span class="linenumber">&nbsp;29|</span><br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;GetSquare()&nbsp;const&nbsp;{&nbsp;return&nbsp;Value*Value;&nbsp;}<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;Add(tjs_int&nbsp;n)&nbsp;{&nbsp;Value&nbsp;+=&nbsp;n;&nbsp;}<br />
<span class="linenumber">&nbsp;32|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;Print()&nbsp;const&nbsp;{&nbsp;printf(&quot;%d\n&quot;,&nbsp;Value);&nbsp;}<br />
<span class="linenumber">&nbsp;33|</span><br />
<span class="linenumber">&nbsp;34|</span>private:<br />
<span class="linenumber">&nbsp;35|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;Value;&nbsp;<span class="comment">//&nbsp;值</span><br />
<span class="linenumber">&nbsp;36|</span>};<br />
</code>
<br />

<br />
<dl>
<dt>35行目</dt>
<dd>　话说回来，这是数据成员。原生实例可以自由编写所需的数据成员。</dd>

<dt>4～8行目</dt>
<dd>　NI_Test的构造函数。建议在这里完成C++类的初始化，而让后面的Construct方法只进行最小限度的初始化。<br />
　在这个例子中，将数据成员Value的初始值设为0。</dd>


<dt>10～20行目</dt>
<dd>　当使用new运算符创建TJS2对象时被调用。numparams和param参数表示传递给new运算符的参数。<br />
　tjs_obj参数是要创建的TJS对象。<br />
　在这个例子中，如果有参数（并且它不是void），则将其设置为Value的初始值。</dd>


<dt>22～25行目</dt>
<dd>　当对象被无效化时调用的方法。可以在这里编写终结处理。<br />
　在这个例子中不做任何事情。</dd>


<dt>27～32行目</dt>
<dd>　操作数据成员的公共方法。在后面的原生类中，将编写使用这些方法的代码。</dd></dl><br />
　要创建对象，需要类，所以接下来描述类。类以从tTJSNativeClass派生的形式实现。tTJSNativeClass具有iTJSDispatch2接口，并实现了作为原生类的基本操作。<br />
　在原生类的构造函数中描述从TJS可访问的方法和属性。<br />
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;NC_Test&nbsp;:&nbsp;public&nbsp;tTJSNativeClass&nbsp;<span class="comment">//&nbsp;原生类</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;NC_Test();&nbsp;<span class="comment">//&nbsp;构造函数;&nbsp;在下面描述</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;tjs_uint32&nbsp;ClassID;&nbsp;<span class="comment">//&nbsp;类ID</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>private:<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;tTJSNativeInstance&nbsp;*CreateNativeInstance()<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;NI_Test();&nbsp;<span class="comment">//&nbsp;创建并返回原生实例</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;13|</span>};<br />
<span class="linenumber">&nbsp;14|</span>tjs_uint32&nbsp;NC_Test::ClassID&nbsp;=&nbsp;(tjs_uint32)-1;&nbsp;<span class="comment">//&nbsp;类ID</span><br />
</code>
<br />

<br />
<dl>
<dt>4行目</dt>
<dd>　这个类的构造函数，实现将在后面描述。</dd>


<dt>6行目</dt>
<dd>　保存这个类的类ID的变量。第14行有实体。</dd>


<dt>9～12行目</dt>
<dd>　CreateNativeInstance方法是在应该创建原生实例的时机调用的方法。这里创建并返回NI_Test类的对象。</dd></dl><br />
<br />
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>NC_Test::NC_Test()&nbsp;:&nbsp;tTJSNativeClass(TJS_W(&quot;Test&quot;))<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_MEMBERS(<span class="comment">/*TJS类名*/</span>Test)<br />
<span class="linenumber">&nbsp;&nbsp;4|</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_DECL_EMPTY_FINALIZE_METHOD<br />
<span class="linenumber">&nbsp;&nbsp;6|</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_CONSTRUCTOR_DECL(<br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*变量名*/</span>_this,<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*变量类型*/</span>NI_Test,<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*TJS类名*/</span>Test)<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;也可以在NI_Test::Construct中编写内容</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;所以这里不做任何事情</span><br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_CONSTRUCTOR_DECL(<span class="comment">/*TJS类名*/</span>Test)<br />
<span class="linenumber">&nbsp;17|</span><br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_METHOD_DECL(<span class="comment">/*函数名*/</span>print)&nbsp;<span class="comment">//&nbsp;print方法</span><br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*变量名*/</span>_this,<br />
<span class="linenumber">&nbsp;21|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*变量类型*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;22|</span><br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;Print();<br />
<span class="linenumber">&nbsp;24|</span><br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;26|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_METHOD_DECL(<span class="comment">/*函数名*/</span>print)<br />
<span class="linenumber">&nbsp;28|</span><br />
<span class="linenumber">&nbsp;29|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_METHOD_DECL(<span class="comment">/*函数名*/</span>add)&nbsp;<span class="comment">//&nbsp;add方法</span><br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*变量名*/</span>_this,<br />
<span class="linenumber">&nbsp;32|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*变量类型*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;33|</span><br />
<span class="linenumber">&nbsp;34|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&lt;&nbsp;1)&nbsp;return&nbsp;TJS_E_BADPARAMCOUNT;<br />
<span class="linenumber">&nbsp;35|</span><br />
<span class="linenumber">&nbsp;36|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;Add((tjs_int)*param[0]);<br />
<span class="linenumber">&nbsp;37|</span><br />
<span class="linenumber">&nbsp;38|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;39|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;40|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_METHOD_DECL(<span class="comment">/*函数名*/</span>add)<br />
<span class="linenumber">&nbsp;41|</span><br />
<span class="linenumber">&nbsp;42|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_DECL(value)&nbsp;<span class="comment">//&nbsp;value属性</span><br />
<span class="linenumber">&nbsp;43|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;44|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;45|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;46|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*变量名*/</span>_this,<br />
<span class="linenumber">&nbsp;47|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*变量类型*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;48|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;_this-&gt;GetValue();<br />
<span class="linenumber">&nbsp;49|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;50|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;51|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;52|</span><br />
<span class="linenumber">&nbsp;53|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;54|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;55|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*变量名*/</span>_this,<br />
<span class="linenumber">&nbsp;56|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*变量类型*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;57|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;SetValue((tjs_int)*param);<br />
<span class="linenumber">&nbsp;58|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;59|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;60|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;61|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;62|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_DECL(value)<br />
<span class="linenumber">&nbsp;63|</span><br />
<span class="linenumber">&nbsp;64|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_DECL(square)&nbsp;<span class="comment">//&nbsp;square只读属性</span><br />
<span class="linenumber">&nbsp;65|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;66|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;67|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;68|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*变量名*/</span>_this,<br />
<span class="linenumber">&nbsp;69|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*变量类型*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;70|</span><br />
<span class="linenumber">&nbsp;71|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;_this-&gt;GetSquare();<br />
<span class="linenumber">&nbsp;72|</span><br />
<span class="linenumber">&nbsp;73|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;74|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;75|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;76|</span><br />
<span class="linenumber">&nbsp;77|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_DENY_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;78|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;79|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_DECL(square)<br />
<span class="linenumber">&nbsp;80|</span><br />
<span class="linenumber">&nbsp;81|</span>&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_MEMBERS<br />
<span class="linenumber">&nbsp;82|</span>}<br />
</code>
<br />

<br />
<dl>
<dt>1行目</dt>
<dd>　NC_Test的构造函数。父类tTJSNativeClass的构造函数需要指定在TJS2中使用的类名。</dd>


<dt>3行目</dt>
<dd>　TJS_BEGIN_NATIVE_MEMBERS宏。参数指定在TJS2中使用的类名。<br />
　在这个宏和TJS_END_NATIVE_MEMBERS宏之间的位置描述作为类成员的方法和属性。</dd>


<dt>4行目</dt>
<dd>　声明一个空的finalize方法。对应于finalize的处理也可以通过重写tTJSNativeInstance::Invalidate来实现，所以通常空方法就足够了。
</dd>


<dt>7～16行目</dt>
<dd>　声明（TJS的）构造函数。相当于在TJS中编写类时，在类内声明与类同名的方法的部分。<br />
<br />
　TJS_BEGIN_NATIVE_CONSTRUCTOR_DECL宏的第1个参数是分配给原生实例的变量名，第2个参数是该变量的类型名。在这个例子中，在这个块内可以使用NI_Test *_this变量，可以访问原生实例。<br />
　宏的第3个参数指定在TJS中使用的类名。TJS_END_NATIVE_CONSTRUCTOR_DECL宏的参数也是如此。<br />
　这里，对应于构造函数的处理也可以通过重写tTJSNativeInstance::Construct来实现，所以这里不做任何事情，只返回S_OK。
</dd>


<dt>18～27行目</dt>
<dd>　声明print方法。方法名需要在TJS_BEGIN_NATIVE_METHOD_DECL和TJS_END_NATIVE_METHOD_DECL两个宏中指定相同的名称。<br />
　在这个宏内可以使用tjs_int numparams和tTJSVariant **param变量，它们分别表示传递的参数数量和参数。这个方法没有使用它们。<br />
　20～21行是从对象中取出原生实例的宏。在这个例子中，意味着将原生实例提取到名为_this的NI_Test *类型变量中。此后，可以使用_this变量访问原生实例。在第23行，调用该原生实例的Print方法。</dd>


<dt>29～40行目</dt>
<dd>　声明add方法。这里使用了numparams和param。</dd>



<dt>42～62行目</dt>
<dd>　声明value属性。与方法声明一样，在TJS_BEGIN_NATIVE_PROP_DECL和TJS_END_NATIVE_PROP_DECL两个宏中指定属性名。<br />
<br />
　在TJS_BEGIN_NATIVE_PROP_GETTER和TJS_END_NATIVE_PROP_GETTER宏之间，可以描述getter。在getter中，需要设置tTJSVariant类型的*result的值。<br />
　同样，在TJS_BEGIN_NATIVE_PROP_SETTER和TJS_END_NATIVE_PROP_SETTER宏之间可以描述setter。在setter中，要设置的值存储在tTJSVariant类型的*param中，使用它进行处理。</dd>


<dt>64～79行目</dt>
<dd>　这里声明只读属性。通过使用TJS_DENY_NATIVE_PROP_SETTER代替setter，可以创建只读属性。</dd></dl><br />
<br />
<br />
　原生类的注册方式与原生函数相同。下面示例测试代码：<br />
<br />

<br />
<code class="bq"><span class="weak">例:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;获取全局对象</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span><br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*cls&nbsp;=&nbsp;new&nbsp;NC_Test();&nbsp;<span class="comment">//&nbsp;创建NC_Test对象</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;cls_var(cls);&nbsp;<span class="comment">//&nbsp;将对象设置到tTJSVariant类型的cls_var中</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cls-&gt;Release();&nbsp;<span class="comment">//&nbsp;释放cls</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global-&gt;PropSet(TJS_MEMBERENSURE,&nbsp;TJS_W(&quot;Test&quot;),&nbsp;NULL,&nbsp;&amp;cls_var,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;注册</span><br />
<span class="linenumber">&nbsp;11|</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(TJS_W(<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;var&nbsp;test&nbsp;=&nbsp;new&nbsp;Test();\n&quot;<br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test.value&nbsp;=&nbsp;5;\n&quot;<br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;var&nbsp;test2&nbsp;=&nbsp;new&nbsp;Test(test.square);\n&quot;<br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test2.add(3);\n&quot;<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test2.print();\n\0&quot;),<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;NULL,&nbsp;NULL);&nbsp;<span class="comment">//&nbsp;执行脚本</span><br />
</code>
<br />

<br />
</div></div>
	<script type="text/javascript" charset="UTF-8" src="documentid.js" ></script>
	<script type="text/javascript" charset="UTF-8" src="postcontent.js" ></script>
</body>
</html>
